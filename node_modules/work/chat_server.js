/**
 * Created by lyle on 14-4-2.
 */

exports.begin = function(httpApp)
{
    var io = require('socket.io').listen(httpApp);
    var fs = require('fs');
    var logFile = "./logFile";
    var counter = 0; //计数器变量

    io.sockets.on('connection',function(socket)
    {
        ++counter;
        var data = new Date()+" : user connected : "+counter;
        fs.appendFile(logFile,data);

        socket.emit('users',{howManyPeople:counter});//仅仅通知当前用户

        socket.broadcast.emit('users',{howManyPeople:counter});//通知所有用户

        socket.on('disconnect',function()
        {
            --counter;
            var s1 = new Date()+" : user disconnet : "+counter;
            fs.appendFile(logFile,s1);

            socket.broadcast.emit('users',{howManyPeople:counter});
        });

        socket.on('sendMessage',function(data)
        {
            console.log(data.text);
            socket.broadcast.emit('broadcastMessage',data);
        });
    });
}