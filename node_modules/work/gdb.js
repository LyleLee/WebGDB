/**
 * Created by lyle on 14-4-13.
 */

/*命令传到gdb,进行交互*/
exports.interactive = function(socket)
{
    var staticVar = require('./staticVar.js');
    var spawn = require("child_process").spawn;
    var binaryFile = staticVar.getBinaryFile();
    var gdb = spawn('gdb');

    console.log("开始调试");

    gdb.stdout.setEncoding('utf8');
    gdb.stderr.setEncoding('utf8');
    gdb.stdin.setEncoding('utf8');

    gdb.stderr.on('data',function(data)
    {
        var status = { };
        status.index = 5;
        status.gdbOutput = data;
        console.log("gdb标准出错:"+data);
        socket.emit('status',status);
    });

    gdb.stdout.on('data',function(data)
    {
        var status = { };
        status.index = 4;
        status.gdbOutput = data;
        console.log("gdb标准输出:"+data);
        socket.emit('status',status);
    });

    gdb.on('exit',function(code,signal){
        console.log("gdb已经退出 code:"+code+" signal:"+signal);
    });

    socket.on('debug',function(debug){
        if(debug.command.length > 0)
        {
            if(debug.command == "start")
            {
                console.log("执行命令:"+"file "+binaryFile+"\n");
                gdb.stdin.write("file "+binaryFile+"\n");
                return;
            }
                console.log("执行命令:"+debug.command);
                gdb.stdin.write(debug.command+"\n");
        }
    });
};
